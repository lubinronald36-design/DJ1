<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DJ1 ‚Äî Pads + Samples + Synth + FX (FULL)</title>

<style>
body{margin:0;padding:20px;font-family:system-ui,Arial;background:#0b0d12;color:#eaeaff}
.wrap{max-width:1100px;margin:auto}
h1{margin:0 0 6px}
.muted{color:#aab3d6}
.card{background:#141826;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:14px;margin:12px 0}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.12);color:#fff;font-weight:800;cursor:pointer}
button:hover{transform:translateY(-1px)}
button:disabled{opacity:.5;cursor:not-allowed}
.primary{background:#fff;color:#0b0d12;border-color:transparent}
.danger{background:rgba(255,77,77,.18);border-color:rgba(255,77,77,.35)}
.pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:#c7cfef;font-size:13px}
input[type="range"]{width:160px}
select{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.08);color:#fff;font-weight:800}
.status{margin-top:10px;font-size:13px;color:#aab3d6}
.mono{font-family:ui-monospace,monospace}
audio{width:100%}
.small{font-size:12px;color:#aab3d6}
a{color:#9fffcf}

/* PADS */
.pads{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
@media (max-width:880px){ .pads{grid-template-columns:repeat(4,minmax(0,1fr));} }
@media (max-width:520px){ .pads{grid-template-columns:repeat(3,minmax(0,1fr));} }

.pad{
  user-select:none;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  padding:12px;
  min-height:72px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  cursor:pointer;
  transition:transform .06s ease;
}
.pad:active{transform:scale(.98)}
.pad.on{
  outline:2px solid rgba(159,255,207,.55);
  background:rgba(159,255,207,.10);
}
.padTop{display:flex;justify-content:space-between;align-items:center;gap:10px}
.padKey{font-weight:1000;font-size:18px}
.padMode{font-size:11px;color:#aab3d6}
.padName{font-size:12px;color:#c7cfef;opacity:.95;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ASSIGNMENT LIST */
.assignGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media (max-width:880px){ .assignGrid{grid-template-columns:1fr} }
.assignRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.assignRow .k{min-width:40px;text-align:center;font-weight:1000;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:8px 10px;background:rgba(255,255,255,.07)}
.assignRow select{flex:1;min-width:220px}
</style>
</head>

<body>
<div class="wrap">
<h1>DJ1 ‚Äî Pads + Samples + Synth + FX</h1>
<p class="muted">
Repo files (same folder): <span class="mono">bott.mp3</span>, <span class="mono">dj-elvis-dante.wav</span>, <span class="mono">boom.wav</span>
</p>

<!-- BEAT -->
<div class="card">
  <div class="row">
    <button id="startBeat" class="primary">‚ñ∂ Start Beat</button>
    <button id="stopBeat" class="danger" disabled>‚ñ† Stop Beat</button>

    <span class="pill">
      Beat Vol
      <input id="beatVol" type="range" min="0" max="1" step="0.01" value="0.75">
      <span id="beatVolLabel" class="mono">0.75</span>
    </span>

    <span class="pill">
      Key Vol
      <input id="keyVol" type="range" min="0" max="1" step="0.01" value="0.65">
      <span id="keyVolLabel" class="mono">0.65</span>
    </span>

    <span class="pill">
      Synth Level
      <input id="synthAmt" type="range" min="0" max="1" step="0.01" value="0.35">
      <span id="synthLabel" class="mono">0.35</span>
    </span>
  </div>
  <div class="status" id="status">Status: ready.</div>
</div>

<!-- LOAD SOUNDS + MODE -->
<div class="card">
  <div class="row">
    <label class="pill" style="cursor:pointer">
      üéöÔ∏è Load key samples (multi-files)
      <input id="sampleFiles" type="file" accept="audio/*" multiple style="display:none">
    </label>

    <label class="pill" style="cursor:pointer">
      üìÅ Load a folder (desktop Chrome)
      <input id="sampleFolder" type="file" accept="audio/*" multiple webkitdirectory style="display:none">
    </label>

    <select id="keyMode" title="How keys play">
      <option value="both" selected>Keys: BOTH (Samples + Synth)</option>
      <option value="samples">Keys: Samples only</option>
      <option value="synth">Keys: Synth only</option>
    </select>

    <button id="clearBank" class="danger">Clear Bank</button>
    <button id="resetAssign" class="danger">Reset Assign</button>
  </div>

  <div class="small">
    You can <b>assign any sample to any key</b> below. Assignments auto-save in your browser.
  </div>

  <div class="status" id="bankStatus">Sample Bank: none loaded yet.</div>
</div>

<!-- FX (FIXED: ON/OFF + MIX + SOFT DISTORTION + SAFE ECHO) -->
<div class="card">
  <div class="row">
    <button id="elvisBtn" class="primary">üéôÔ∏è ELVIS</button>
    <button id="boomBtn">üí• BOOM</button>

    <button id="fxToggle" class="primary">FX: ON</button>

    <span class="pill">
      FX MIX
      <input id="mixAmt" type="range" min="0" max="1" step="0.01" value="0.22">
      <span id="mixLabel" class="mono">0.22</span>
    </span>

    <span class="pill">
      Echo
      <input id="echoAmt" type="range" min="0" max="1" step="0.01" value="0.18">
      <span id="echoLabel" class="mono">0.18</span>
    </span>

    <span class="pill">
      Filter
      <input id="filterAmt" type="range" min="0" max="1" step="0.01" value="0.10">
      <span id="filterLabel" class="mono">0.10</span>
    </span>

    <span class="pill">
      Distort
      <input id="distAmt" type="range" min="0" max="1" step="0.01" value="0.06">
      <span id="distLabel" class="mono">0.06</span>
    </span>

    <span class="pill">
      Reverb
      <input id="reverbAmt" type="range" min="0" max="1" step="0.01" value="0.14">
      <span id="reverbLabel" class="mono">0.14</span>
    </span>
  </div>

  <div class="small">
    If FX is annoying: set <b>FX MIX</b> to 0.10‚Äì0.25 or tap <b>FX: OFF</b>.
  </div>
</div>

<!-- PADS -->
<div class="card">
  <div class="row" style="justify-content:space-between;align-items:flex-end">
    <div>
      <div class="muted"><b>DJ Pads</b> (tap or press keyboard)</div>
      <div class="small">Keys: ASDFGHJKL + QWERTYUIOP</div>
    </div>
    <div class="small">Tip: mobile users can play by tapping pads.</div>
  </div>

  <div id="pads" class="pads" style="margin-top:10px"></div>
</div>

<!-- ASSIGNMENT -->
<div class="card">
  <div class="muted"><b>Assign samples to keys</b></div>
  <div class="small">Pick a sample for each key. Saved automatically.</div>
  <div id="assignments" class="assignGrid" style="margin-top:10px"></div>
</div>

<!-- RECORDER -->
<div class="card">
  <div class="row">
    <button id="recBtn" class="primary">‚è∫ Start Recording</button>
    <button id="stopRecBtn" class="danger" disabled>‚èπ Stop & Save</button>
  </div>
  <div class="status" id="recStatus">Recorder: idle.</div>
  <audio id="playback" controls></audio>
  <a id="download" style="display:none">‚¨á Download recording</a>
  <div class="small">Note: mic recording needs HTTPS (GitHub Pages is fine).</div>
</div>

</div>

<script>
/* FILES */
const BEAT_FILE="bott.mp3";
const ELVIS_FILE="dj-elvis-dante.wav";
const BOOM_FILE="boom.wav";

/* KEYS */
const KEY_ORDER = "ASDFGHJKLQWERTYUIOP".split("");
const KEYS = new Set(KEY_ORDER);

/* STORAGE */
const STORAGE_KEY = "dj1_assignments_v1";

/* UI */
const statusEl=document.getElementById("status");
const bankStatus=document.getElementById("bankStatus");

const startBeat=document.getElementById("startBeat");
const stopBeat=document.getElementById("stopBeat");
const beatVol=document.getElementById("beatVol");
const beatVolLabel=document.getElementById("beatVolLabel");
const keyVol=document.getElementById("keyVol");
const keyVolLabel=document.getElementById("keyVolLabel");

const synthAmt=document.getElementById("synthAmt");
const synthLabel=document.getElementById("synthLabel");

const elvisBtn=document.getElementById("elvisBtn");
const boomBtn=document.getElementById("boomBtn");

const sampleFiles=document.getElementById("sampleFiles");
const sampleFolder=document.getElementById("sampleFolder");
const keyMode=document.getElementById("keyMode");
const clearBank=document.getElementById("clearBank");
const resetAssign=document.getElementById("resetAssign");

const fxToggle=document.getElementById("fxToggle");
const mixAmt=document.getElementById("mixAmt");
const mixLabel=document.getElementById("mixLabel");
const echoAmt=document.getElementById("echoAmt");
const filterAmt=document.getElementById("filterAmt");
const distAmt=document.getElementById("distAmt");
const reverbAmt=document.getElementById("reverbAmt");
const echoLabel=document.getElementById("echoLabel");
const filterLabel=document.getElementById("filterLabel");
const distLabel=document.getElementById("distLabel");
const reverbLabel=document.getElementById("reverbLabel");

const padsEl=document.getElementById("pads");
const assignmentsEl=document.getElementById("assignments");

/* SIMPLE AUDIO */
const beat=new Audio(BEAT_FILE); beat.loop=true;
const elvis=new Audio(ELVIS_FILE);
const boom=new Audio(BOOM_FILE);

/* WEB AUDIO */
let ctx;
function ac(){ if(!ctx) ctx=new (window.AudioContext||window.webkitAudioContext)(); return ctx; }

/* Sample list (raw) and decoded buffers */
let loadedFiles = []; // [{name, file}]
const sampleBuffers = new Map(); // name => AudioBuffer

/* Assignment map: key => sampleName | "" */
let assignments = loadAssignments();

/* FX graph nodes */
let master, dryGain, fxIn, filter, delay, feedback, reverbSend, convolver, distort, wetGain;
let fxEnabled = true;

function saveAssignments(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(assignments)); }catch{}
}
function loadAssignments(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return Object.fromEntries(KEY_ORDER.map(k=>[k,""]));
    const obj = JSON.parse(raw);
    // ensure all keys exist
    for(const k of KEY_ORDER){ if(typeof obj[k] !== "string") obj[k] = ""; }
    return obj;
  }catch{
    return Object.fromEntries(KEY_ORDER.map(k=>[k,""]));
  }
}

/* Impulse reverb */
function makeImpulse(seconds=1.6, decay=2.2){
  const c = ac();
  const rate = c.sampleRate;
  const length = Math.floor(rate * seconds);
  const impulse = c.createBuffer(2, length, rate);
  for(let ch=0; ch<2; ch++){
    const data = impulse.getChannelData(ch);
    for(let i=0;i<length;i++){
      data[i]=(Math.random()*2-1)*Math.pow(1 - i/length, decay);
    }
  }
  return impulse;
}

/* Soft distortion */
function makeDistortionCurve(amount){
  const n = 44100;
  const curve = new Float32Array(n);
  const a = Math.max(0, Math.min(1, amount));
  const drive = 1 + a * 12;
  for(let i=0;i<n;i++){
    const x = (i*2/n) - 1;
    curve[i] = Math.tanh(x * drive);
  }
  return curve;
}

function ensureGraph(){
  const c = ac();
  if(master) return;

  master = c.createGain();
  master.gain.value = 0.65;

  dryGain = c.createGain();
  dryGain.gain.value = 1.0;

  fxIn = c.createGain();
  fxIn.gain.value = 1.0;

  filter = c.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.value = 18000;

  distort = c.createWaveShaper();
  distort.curve = makeDistortionCurve(0);
  distort.oversample = "4x";

  delay = c.createDelay(1.0);
  delay.delayTime.value = 0.14;

  feedback = c.createGain();
  feedback.gain.value = 0.12;

  convolver = c.createConvolver();
  convolver.buffer = makeImpulse(1.6, 2.2);

  reverbSend = c.createGain();
  reverbSend.gain.value = 0.10;

  wetGain = c.createGain();
  wetGain.gain.value = 0.0;

  // feedback loop
  delay.connect(feedback);
  feedback.connect(delay);

  // FX chain
  fxIn.connect(filter);
  filter.connect(distort);
  distort.connect(delay);
  delay.connect(wetGain);

  // Reverb
  fxIn.connect(reverbSend);
  reverbSend.connect(convolver);
  convolver.connect(wetGain);

  // dry + wet to master
  dryGain.connect(master);
  wetGain.connect(master);

  master.connect(c.destination);

  syncFX();
}

function syncFX(){
  echoLabel.textContent = (+echoAmt.value).toFixed(2);
  filterLabel.textContent = (+filterAmt.value).toFixed(2);
  distLabel.textContent = (+distAmt.value).toFixed(2);
  reverbLabel.textContent = (+reverbAmt.value).toFixed(2);
  mixLabel.textContent = (+mixAmt.value).toFixed(2);

  if(!master) return;

  master.gain.value = Math.max(0.05, +keyVol.value);

  const mix = fxEnabled ? (+mixAmt.value) : 0;
  dryGain.gain.value = 1 - (mix * 0.85);
  wetGain.gain.value = mix;

  const e = +echoAmt.value;
  delay.delayTime.value = 0.10 + e * 0.18;
  feedback.gain.value  = Math.min(0.45, e * 0.55);

  const f = +filterAmt.value;
  const minF = 900;
  const maxF = 18000;
  filter.frequency.value = maxF - f * (maxF - minF);

  const d = +distAmt.value;
  distort.curve = makeDistortionCurve(d);

  const r = +reverbAmt.value;
  reverbSend.gain.value = r * 0.45;
}

mixAmt.oninput = syncFX;
echoAmt.oninput=syncFX;
filterAmt.oninput=syncFX;
distAmt.oninput=syncFX;
reverbAmt.oninput=syncFX;

fxToggle.onclick = ()=>{
  fxEnabled = !fxEnabled;
  fxToggle.textContent = fxEnabled ? "FX: ON" : "FX: OFF";
  syncFX();
};

function syncLabels(){
  beatVolLabel.textContent=(+beatVol.value).toFixed(2);
  keyVolLabel.textContent=(+keyVol.value).toFixed(2);
  synthLabel.textContent=(+synthAmt.value).toFixed(2);
}
beatVol.oninput=()=>{ beat.volume=+beatVol.value; syncLabels(); };
keyVol.oninput=()=>{ syncLabels(); syncFX(); };
synthAmt.oninput=()=>{ syncLabels(); };
beat.volume=+beatVol.value; syncLabels();

/* Beat buttons */
startBeat.onclick=async()=>{
  try{
    await ac().resume();
    ensureGraph();
    beat.currentTime=0;
    await beat.play();
    startBeat.disabled=true; stopBeat.disabled=false;
    statusEl.textContent="Status: beat playing";
  }catch{
    statusEl.textContent="‚ùå bott.mp3 missing";
  }
};
stopBeat.onclick=()=>{
  beat.pause(); beat.currentTime=0;
  startBeat.disabled=false; stopBeat.disabled=true;
  statusEl.textContent="Status: stopped";
};

/* FX buttons */
elvisBtn.onclick=async()=>{ try{await ac().resume(); elvis.currentTime=0; await elvis.play();}catch{} };
boomBtn.onclick=async()=>{ try{await ac().resume(); boom.currentTime=0; await boom.play();}catch{} };

/* Build Pads UI */
function renderPads(){
  padsEl.innerHTML = "";
  for(const k of KEY_ORDER){
    const div = document.createElement("div");
    div.className = "pad";
    div.dataset.key = k;
    div.innerHTML = `
      <div class="padTop">
        <div class="padKey">${k}</div>
        <div class="padMode">${keyMode.value.toUpperCase()}</div>
      </div>
      <div class="padName">${assignments[k] ? assignments[k] : "‚Äî no sample ‚Äî"}</div>
    `;
    div.addEventListener("pointerdown", async (e)=>{
      e.preventDefault();
      await triggerKey(k);
      flashPad(k);
    });
    padsEl.appendChild(div);
  }
}
function flashPad(k){
  const pad = padsEl.querySelector(`.pad[data-key="${k}"]`);
  if(!pad) return;
  pad.classList.add("on");
  setTimeout(()=>pad.classList.remove("on"), 90);
}

/* Assignment UI */
function renderAssignments(){
  assignmentsEl.innerHTML = "";
  for(const k of KEY_ORDER){
    const row = document.createElement("div");
    row.className = "assignRow";
    row.innerHTML = `
      <div class="k">${k}</div>
      <select data-key="${k}"></select>
    `;
    const sel = row.querySelector("select");
    fillSelect(sel, assignments[k]);
    sel.addEventListener("change", ()=>{
      assignments[k] = sel.value;
      saveAssignments();
      renderPads();
    });
    assignmentsEl.appendChild(row);
  }
}
function fillSelect(sel, current){
  sel.innerHTML = "";
  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "‚Äî no sample ‚Äî";
  sel.appendChild(opt0);

  for(const f of loadedFiles){
    const o = document.createElement("option");
    o.value = f.name;
    o.textContent = f.name;
    sel.appendChild(o);
  }
  sel.value = current || "";
}

/* Load & decode */
async function loadFiles(fileList){
  const files = Array.from(fileList || []).filter(f => f.type.startsWith("audio/"));
  if(!files.length){
    bankStatus.textContent = "Sample Bank: no audio files selected.";
    return;
  }

  await ac().resume();
  ensureGraph();

  loadedFiles = files.map(f => ({name: f.name, file: f}));
  sampleBuffers.clear();

  bankStatus.textContent = "Sample Bank: loading‚Ä¶";

  // decode each file
  const c = ac();
  for(const f of loadedFiles){
    try{
      const arr = await f.file.arrayBuffer();
      const buf = await c.decodeAudioData(arr);
      sampleBuffers.set(f.name, buf);
    }catch{}
  }

  bankStatus.textContent = `Sample Bank: loaded ${sampleBuffers.size} / ${loadedFiles.length} files.`;

  // if a key is assigned to a file name that no longer exists, clear it
  for(const k of KEY_ORDER){
    if(assignments[k] && !sampleBuffers.has(assignments[k])) assignments[k] = "";
  }
  saveAssignments();

  renderAssignments();
  renderPads();
}

sampleFiles.addEventListener("change", e => loadFiles(e.target.files));
sampleFolder.addEventListener("change", e => loadFiles(e.target.files));

clearBank.onclick=()=>{
  loadedFiles = [];
  sampleBuffers.clear();
  bankStatus.textContent = "Sample Bank: cleared.";
  // keep assignments but they won't play until files loaded again
  renderAssignments();
  renderPads();
};

resetAssign.onclick=()=>{
  assignments = Object.fromEntries(KEY_ORDER.map(k=>[k,""]));
  saveAssignments();
  renderAssignments();
  renderPads();
  statusEl.textContent = "Assignments reset.";
};

keyMode.onchange=()=>{
  renderPads();
};

/* Play assigned sample for key */
function playSampleForKey(k){
  const name = assignments[k];
  if(!name) return false;
  const buf = sampleBuffers.get(name);
  if(!buf) return false;

  ensureGraph();
  const c = ac();
  const src = c.createBufferSource();
  src.buffer = buf;

  src.connect(dryGain);
  src.connect(fxIn);

  src.start();
  return true;
}

/* Play synth for key */
function playSynth(){
  ensureGraph();
  const c = ac();

  const o = c.createOscillator();
  const g = c.createGain();

  const now = c.currentTime;
  const base = 180 + Math.random()*820;

  o.type = Math.random() > 0.5 ? "sine" : "triangle";
  o.frequency.setValueAtTime(base, now);
  o.frequency.exponentialRampToValueAtTime(base*0.65, now+0.12);

  const lvl = Math.max(0, Math.min(1, +synthAmt.value));
  g.gain.setValueAtTime(0.001, now);
  g.gain.exponentialRampToValueAtTime(0.40*lvl, now+0.012);
  g.gain.exponentialRampToValueAtTime(0.001, now+0.16);

  o.connect(g);
  g.connect(dryGain);
  g.connect(fxIn);

  o.start(now);
  o.stop(now+0.18);
}

/* Trigger key (used by keyboard + pad taps) */
async function triggerKey(k){
  try{ await ac().resume(); }catch{}
  ensureGraph();

  const mode = keyMode.value;
  let didSample = false;

  if(mode === "samples" || mode === "both") didSample = playSampleForKey(k);
  if(mode === "synth" || mode === "both") playSynth();

  const sampleName = didSample ? assignments[k] : "(no sample)";
  statusEl.textContent = `Key ${k} ‚Üí ${mode.toUpperCase()} | Sample: ${sampleName}`;
}

/* Keyboard */
window.addEventListener("keydown", async (e)=>{
  const k = e.key.toUpperCase();
  if(!KEYS.has(k)) return;
  e.preventDefault();
  await triggerKey(k);
  flashPad(k);
},{passive:false});

/* RECORDER (mic only) */
const recBtn=document.getElementById("recBtn");
const stopRecBtn=document.getElementById("stopRecBtn");
const recStatus=document.getElementById("recStatus");
const playback=document.getElementById("playback");
const download=document.getElementById("download");

let rec, chunks=[], stream;

recBtn.onclick=async()=>{
  stream=await navigator.mediaDevices.getUserMedia({audio:true});
  rec=new MediaRecorder(stream);
  chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const url=URL.createObjectURL(blob);
    playback.src=url;
    download.href=url;
    download.download="dj1-voice.webm";
    download.style.display="inline-block";
    recStatus.textContent="Recorder: saved";
    stream.getTracks().forEach(t=>t.stop());
  };
  rec.start();
  recBtn.disabled=true;
  stopRecBtn.disabled=false;
  recStatus.textContent="Recorder: recording‚Ä¶";
};
stopRecBtn.onclick=()=>{
  rec.stop();
  recBtn.disabled=false;
  stopRecBtn.disabled=true;
};

/* Init UI */
renderPads();
renderAssignments();
</script>
</body>
</html>

